apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: agnos-prod
  labels:
    app.kubernetes.io/part-of: agnos-devops
    environment: prod
data:
  APP_ENV: production
  APP_VERSION: 1.0.0
  PORT: '8080'
  PUBLIC_PORT: '8090'
  HEALTH_PORT: '8081'
  WORKER_INTERVAL: 60s
  LOG_LEVEL: warn
---
# WARNING: Secrets contain placeholder values for local/CI usage only.
# In production, use Sealed Secrets, External Secrets Operator, or SOPS.
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
  namespace: agnos-prod
  labels:
    app.kubernetes.io/part-of: agnos-devops
    environment: prod
type: Opaque
stringData:
  DB_DSN: postgres://agnos_prod:agnos_prod_pass@postgres-rw:5432/agnos_prod?sslmode=require
  POSTGRES_USER: agnos_prod
  POSTGRES_PASSWORD: agnos_prod_pass
  POSTGRES_DB: agnos_prod
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
  namespace: agnos-prod
  labels:
    app: api
    environment: prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: api
        environment: prod
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '8080'
        prometheus.io/path: /metrics
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - api
            topologyKey: kubernetes.io/hostname
      containers:
      - name: api
        image: agnos/api:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8080
          name: internal
        - containerPort: 8090
          name: public
        envFrom:
        - configMapRef:
            name: app-config
        - secretRef:
            name: db-secret
        resources:
          requests:
            cpu: 200m
            memory: 128Mi
          limits:
            cpu: '1'
            memory: 512Mi
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
          successThreshold: 1
        livenessProbe:
          httpGet:
            path: /live
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 20
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /live
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          failureThreshold: 10
      terminationGracePeriodSeconds: 60
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker
  namespace: agnos-prod
  labels:
    app: worker
    environment: prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: worker
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: worker
        environment: prod
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '8081'
        prometheus.io/path: /metrics
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - worker
              topologyKey: kubernetes.io/hostname
      containers:
      - name: worker
        image: agnos/worker:latest
        imagePullPolicy: Never
        envFrom:
        - configMapRef:
            name: app-config
        - secretRef:
            name: db-secret
        resources:
          requests:
            cpu: 200m
            memory: 128Mi
          limits:
            cpu: '1'
            memory: 512Mi
        readinessProbe:
          httpGet:
            path: /ready
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /live
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /live
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 5
          failureThreshold: 10
      terminationGracePeriodSeconds: 60
---
apiVersion: v1
kind: Service
metadata:
  name: api
  namespace: agnos-prod
  labels:
    app: api
    environment: prod
spec:
  type: ClusterIP
  selector:
    app: api
  ports:
  - name: http
    port: 80
    targetPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: api-public
  namespace: agnos-prod
  labels:
    app: api
    environment: prod
spec:
  type: NodePort
  selector:
    app: api
  ports:
  - name: public
    port: 80
    targetPort: 8090
    nodePort: 30092
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-hpa
  namespace: agnos-prod
  labels:
    app: api
    environment: prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
      - type: Pods
        value: 2
        periodSeconds: 30
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: api-pdb
  namespace: agnos-prod
  labels:
    app: api
    environment: prod
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: api
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: worker-pdb
  namespace: agnos-prod
  labels:
    app: worker
    environment: prod
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: worker
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-network-policy
  namespace: agnos-prod
spec:
  podSelector:
    matchLabels:
      app: api
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - ports:
    - protocol: TCP
      port: 8080
  - ports:
    - protocol: TCP
      port: 8090
  egress:
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: postgres
    ports:
    - protocol: TCP
      port: 5432
  - ports:
    - protocol: TCP
      port: 443
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: worker-network-policy
  namespace: agnos-prod
spec:
  podSelector:
    matchLabels:
      app: worker
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - ports:
    - protocol: TCP
      port: 8081
  egress:
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: postgres
    ports:
    - protocol: TCP
      port: 5432
  - ports:
    - protocol: TCP
      port: 443
---
apiVersion: v1
kind: Secret
metadata:
  name: db-credentials
  namespace: agnos-prod
  labels:
    app.kubernetes.io/part-of: agnos-devops
    environment: prod
type: kubernetes.io/basic-auth
stringData:
  username: agnos_prod
  password: agnos_prod_pass
---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres
  namespace: agnos-prod
  labels:
    app.kubernetes.io/part-of: agnos-devops
    environment: prod
spec:
  instances: 3
  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
  bootstrap:
    initdb:
      database: agnos_prod
      owner: agnos_prod
      secret:
        name: db-credentials
  storage:
    size: 10Gi
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: "1"
      memory: 1Gi
  monitoring:
    enablePodMonitor: true
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-backup-pvc
  namespace: agnos-prod
  labels:
    app: postgres
    environment: prod
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: agnos-prod
  labels:
    app: postgres-backup
    environment: prod
spec:
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: pg-backup
            image: postgres:15-alpine
            command:
            - /bin/sh
            - -c
            - |
              set -e
              BACKUP_FILE="/backups/backup-$(date +%Y%m%d-%H%M%S).sql.gz"
              echo "Starting backup: $BACKUP_FILE"
              pg_dump -h postgres-rw -U "$POSTGRES_USER" -d "$POSTGRES_DB" | gzip > "$BACKUP_FILE"
              echo "Backup completed: $BACKUP_FILE"
              # Retain only the last 7 backups
              ls -1t /backups/backup-*.sql.gz | tail -n +8 | xargs -r rm -f
              echo "Cleanup done. Current backups:"
              ls -lh /backups/backup-*.sql.gz
            envFrom:
            - secretRef:
                name: db-secret
            env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: POSTGRES_PASSWORD
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: postgres-backup-pvc
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: agnos-prod
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: postgres
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api
    - podSelector:
        matchLabels:
          app: worker
    ports:
    - protocol: TCP
      port: 5432
  - from:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: postgres
    ports:
    - protocol: TCP
      port: 5432
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-ingress
  namespace: agnos-prod
  labels:
    app: api
    environment: prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  rules:
  - host: api.agnos.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api
            port:
              number: 80
---
apiVersion: v1
kind: LimitRange
metadata:
  name: default-limits
  namespace: agnos-prod
spec:
  limits:
  - default:
      cpu: "1"
      memory: 512Mi
    defaultRequest:
      cpu: 200m
      memory: 128Mi
    type: Container
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: namespace-quota
  namespace: agnos-prod
spec:
  hard:
    requests.cpu: "8"
    requests.memory: 4Gi
    limits.cpu: "16"
    limits.memory: 8Gi
    pods: "50"
